# Linux文件系统

## 虚拟文件系统（VFS）

### 虚拟文件系统的功能

虚拟文件系统提供了对于各种文件系统实现的抽象，为用户态程序提供一致的文件访问接口。常见的文件系统主要分为：

* 基于非易失性存储设备的文件系统
  
  例如用于磁盘、固态硬盘等的Ext系列文件系统等

* 基于易失性存储设备的文件系统
  
  例如Linux系统中的ramfs文件系统等

* 基于网络的文件系统
  
  例如NFS等

### 通用文件模型

VFS提供了一个强大的文件系统应该具有的所有功能特性的抽象，而其实际组织确实基于Ext 2文件系统。在VFS中，用户程序使用文件标识符来标识一个文件，而内核使用`inode`保存文件的元数据。

* `inode`
  
  `inode`是内核用于管理文件的数据结构。`inode`中记录的信息可分为两类：表示文件状态的元数据和保存实际数据内容的数据段。

  对于表示文件的`inode`，其数据段中保存的就是文件的实际内容；而对于表示文件夹的`inode`，其数据段中记录的是文件夹下的所有文件和文件夹的信息，每一条信息包括文件名和文件对应的`inode`的编号两部分。

* 文件链接
  
  文件链接分为软链接（符号链接）和硬链接两种。软链接是与链接目标无关的一个文件，该文件的内容是链接目标的路径；而硬链接则是在文件目录中插入一条与链接目标一致的目录项，插入的目录项与链接目标共享`inode`编号和文件名。
  
  由于在硬链接中中出现了多个目录项指向了同一个`inode`的情况，所以需要使用引用计数来管理`inode`，只有当一个`inode`不被任何目录项引用时才可将其释放。

* 编程接口
  
  用户程序使用`open`或`openat`系统调用打开文件后，会获得一个文件描述符，它是一个大于等于3的整数（0分配给了标准输入，1分配给了标准输出，2分配给了标准错误输出）。当用户程序使用系统调用操作文件时，需要将文件描述符传递给系统调用以指明要操作的文件对象。在Linux引入命名空间后，在不同的上下文中同一个文件描述符可能表示多个不同的文件。

  在内核中，文件描述符是文件对象在进程打开文件中的索引。内核中使用`struct file`结构体表示文件，该结构体中记录了文件的当前状态，包括文件打开模式、读写指针位置等。

* 一切皆文件
  
  Linux继承了UNIX一切皆文件的设计思想，几乎所有的IO操作都可以通过文件读写的方式完成。

### VFS的结构

VFS由文件和文件系统两个部分组成。这两个部分又各自由一组数据结构实现，包括：`struct file`, `struct inode`, `struct dentry`, `struct address_space`, `struct super_block`。

* `struct super_block`

  __文件系统元数据的运行时表示__
  
  超级块是文件系统在存储器上存储元数据的特殊存储块，其中记录了文件系统的大小、存储块布局、存储块使用情况等信息。一般来说不同文件系统的超级块的结构是不同的，文件系统的实现中就包含了其超级块的创建和管理功能。

  而`struct super_block`就是VFS为超级块提供的统一抽象，其中包含了不同文件系统共有的元数据，每种文件系统的实现都需要提供一个`struct super_operations`结构体实例，其中包含操作该文件系统超级块的函数。

  操作系统会为每一个活跃的存储器分区维护一个`struct super_block`实例。

* `struct inode`

  __文件元数据的运行时表示__

  `struct inode`是VFS提供的对`inode`的统一抽象，它保存每一个文件的静态元数据，包括文件大小、文件权限、文件所有者、最后访问时间等静态信息。这些信息要么由相应的文件系统直接存储在硬盘上，要么由内核在从硬盘中读入数据时动态生成。

  不同文件系统的存储方式可能不尽相同，因此文件系统的实现中包括了一个`struct inode_operations`实例，用于保存`inode`操作函数指针。

  `inode`操作主要包括创建链接、文件重命名、文件创建和删除等。

* `struct file`
  
  __文件内容的运行时表示__
  
  这是VFS中文件的表示，用户程序每打开一个尚未被任何程序打开的文件，就会创建一个相应的`struct file`实例，并添加到在相应文件系统的`struct super_block`实例的打开文件列表中。

  `struct file`中保存了打开文件的运行时信息，包括打开模式、引用计数、读写指针位置、内存映射地址空间等。除此之外还有一个指向某个`struct file_operations`实例的指针，该实例中保存了相应文件系统实现的文件操作函数指针。

  文件操作主要包括文件读写、设置读写位置指针、创建内存映射等。

* `struct dentry`
  
  __文件目录项缓存__

  文件目录树的节点，用于保存文件目录项的信息，包括文件名、相应的`inode`等。`dentry`最重要的作用是作为文件系统的缓存，加速文件的查找。

  每当VFS和文件系统实现找到一个目录项之后，就会使用它的名称以及相应的`inode`等创建一个`dentry`实例缓存起来，这样当下一次需要查找同一个文件时，就可以省去访问外存的开销。

  `dentry`同样支持文件系统实现自定义的操作，包括有效性验证、获取散列值、比较、释放、删除等。
